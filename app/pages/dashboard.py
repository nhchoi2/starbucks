import streamlit as st
import pandas as pd
import numpy as np
import pickle

# 1ï¸âƒ£ ëª¨ë¸ ë¡œë“œ
model_path = "models/fatigue_predictor.pkl"
with open(model_path, "rb") as file:
    model = pickle.load(file)

# 2ï¸âƒ£ ì›ë³¸ ë°ì´í„°ì˜ ì»¬ëŸ¼ ë¡œë“œ (ì…ë ¥ ë°ì´í„° ë³€í™˜ì„ ìœ„í•´)
processed_data_path = "data/processed_data.csv"
df_reference = pd.read_csv(processed_data_path)  # ì»¬ëŸ¼ ì´ë¦„ ê°€ì ¸ì˜¤ê¸°
model_features = df_reference.drop(columns=["í”¼ë¡œë„ê°’"]).columns  # ëª¨ë¸ í•™ìŠµì— ì‚¬ìš©í•œ ì»¬ëŸ¼

# 3ï¸âƒ£ í˜ì´ì§€ ì œëª© ë° ì„¤ëª…
st.title("ğŸ“Š í”¼ë¡œë„ ì˜ˆì¸¡ ëŒ€ì‹œë³´ë“œ")
st.write("ì‚¬ìš©ìì˜ ê±´ê°• ë°ì´í„°ë¥¼ ì…ë ¥í•˜ë©´ AIê°€ í”¼ë¡œë„ë¥¼ ì˜ˆì¸¡í•©ë‹ˆë‹¤.")

# 4ï¸âƒ£ ì‚¬ìš©ì ì…ë ¥ ë°›ê¸°
col1, col2 = st.columns(2)

with col1:
    ì„±ë³„ = st.selectbox("ì„±ë³„", ["ë‚¨ì„±", "ì—¬ì„±"])
    í‰ê· ì‹¬ë°•ìˆ˜ = st.slider("í‰ê·  ì‹¬ë°•ìˆ˜ (BPM)", 40, 120, 70)
    ì‹ ì²´ìŠ¤íŠ¸ë ˆìŠ¤ê°’ = st.slider("ì‹ ì²´ ìŠ¤íŠ¸ë ˆìŠ¤ ê°’", 0, 100, 50)
    ìš´ë™ëŸ‰ = st.slider("í•˜ë£¨ í‰ê·  ìš´ë™ëŸ‰ (ë¶„)", 0, 180, 30)

with col2:
    ì •ì‹ ìŠ¤íŠ¸ë ˆìŠ¤ê°’ = st.slider("ì •ì‹  ìŠ¤íŠ¸ë ˆìŠ¤ ê°’", 0, 100, 50)
    í˜ˆê´€ì—°ë ¹ = st.slider("í˜ˆê´€ ì—°ë ¹ (ì„¸)", 20, 80, 40)
    ì´ìƒì‹¬ë°•ìˆ˜ = st.slider("ì´ìƒ ì‹¬ë°•ìˆ˜ (BPM)", 40, 150, 80)
    ìˆ˜ë©´ì‹œê°„ = st.slider("í•˜ë£¨ í‰ê·  ìˆ˜ë©´ ì‹œê°„ (ì‹œê°„)", 3, 12, 7)

# 5ï¸âƒ£ ì…ë ¥ ë°ì´í„° ì „ì²˜ë¦¬
ì„±ë³„ = 0 if ì„±ë³„ == "ë‚¨ì„±" else 1  # ë‚¨ì„± = 0, ì—¬ì„± = 1

# ì…ë ¥ê°’ì„ DataFrameìœ¼ë¡œ ë³€í™˜ (960ê°œ ì»¬ëŸ¼ì„ ë§ì¶”ê¸° ìœ„í•´)
input_data = pd.DataFrame([[í‰ê· ì‹¬ë°•ìˆ˜, ì´ìƒì‹¬ë°•ìˆ˜, ì‹ ì²´ìŠ¤íŠ¸ë ˆìŠ¤ê°’, ì •ì‹ ìŠ¤íŠ¸ë ˆìŠ¤ê°’, í˜ˆê´€ì—°ë ¹, ì„±ë³„, ìš´ë™ëŸ‰, ìˆ˜ë©´ì‹œê°„]],
                          columns=["í‰ê· ì‹¬ë°•ìˆ˜", "ì´ìƒì‹¬ë°•ìˆ˜", "ì‹ ì²´ìŠ¤íŠ¸ë ˆìŠ¤ê°’", "ì •ì‹ ìŠ¤íŠ¸ë ˆìŠ¤ê°’", "í˜ˆê´€ì—°ë ¹", "ì„±ë³„", "ìš´ë™ëŸ‰", "ìˆ˜ë©´ì‹œê°„"])

# 6ï¸âƒ£ ëª¨ë¸ í•™ìŠµ ë°ì´í„°ì˜ ì»¬ëŸ¼ì„ ê¸°ì¤€ìœ¼ë¡œ ì…ë ¥ê°’ ì •ë ¬ (ë¶€ì¡±í•œ ì»¬ëŸ¼ì€ 0ìœ¼ë¡œ ì±„ìš°ê¸°)
input_data = input_data.reindex(columns=model_features, fill_value=0)

# 7ï¸âƒ£ ì˜ˆì¸¡ ì‹¤í–‰
if st.button("ğŸš€ í”¼ë¡œë„ ì˜ˆì¸¡í•˜ê¸°"):
    prediction = model.predict(input_data)[0]  # í”¼ë¡œë„ ì˜ˆì¸¡ ê°’
    st.success(f"ğŸ“Š ì˜ˆì¸¡ëœ í”¼ë¡œë„ ê°’: {prediction:.2f}")

    # í”¼ë¡œë„ ìˆ˜ì¤€ì— ë”°ë¥¸ ë©”ì‹œì§€
    if prediction < 3:
        st.info("ğŸ”¹ í”¼ë¡œë„ê°€ ë‚®ìŠµë‹ˆë‹¤! í˜„ì¬ ìƒíƒœë¥¼ ìœ ì§€í•˜ì„¸ìš”.")
    elif prediction < 6:
        st.warning("âš ï¸ í”¼ë¡œë„ê°€ ì¤‘ê°„ ìˆ˜ì¤€ì…ë‹ˆë‹¤. ì¶©ë¶„í•œ íœ´ì‹ì´ í•„ìš”í•©ë‹ˆë‹¤!")
    else:
        st.error("ğŸš¨ í”¼ë¡œë„ê°€ ë†’ìŠµë‹ˆë‹¤! ì¦‰ì‹œ íœ´ì‹ì„ ì·¨í•˜ì„¸ìš”.")

    # âœ… í”¼ë¡œë„ ì˜ˆì¸¡ ê²°ê³¼ ì‹œê°í™” ì¶”ê°€
    st.progress(int(prediction * 10))
